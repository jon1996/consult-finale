server {
  listen 80;
  server_name drcbusinessconsult.com www.drcbusinessconsult.com 54.91.120.244 _;

  # Standard proxy headers
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # ---- PHP site at root ----
  root /var/www/consult-drc-main;
  index index.php index.html;

  # Django static and media files
  # Serve under the standard /static and /media paths (matches STATIC_URL)
  location ^~ /static/ {
    alias /srv/django/static/;
    try_files $uri =404;
    access_log off;
    expires 30d;
  }

  location ^~ /media/ {
    alias /srv/django/media/;
    try_files $uri =404;
    access_log off;
    expires 30d;
  }

  # Keep compatibility for existing /app/ prefixed URLs used by the project
  location ^~ /app/static/ {
    alias /srv/django/static/;
    try_files $uri =404;
    access_log off;
    expires 30d;
  }

  location ^~ /app/media/ {
    alias /srv/django/media/;
    try_files $uri =404;
    access_log off;
    expires 30d;
  }

  # ---- Django under /app/ ----
  location /app/ {
    # en-tÃªtes standard
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  # forward internal API key header if present
  proxy_set_header X-Internal-API-Key $http_x_internal_api_key;

  # IMPORTANT: a proxy_pass without trailing slash preserves the original /app/ prefix
  # so Django receives /app/space/ etc. Keep consistent to match project's URL mounts.
  proxy_pass http://django:8000;

    proxy_redirect off;
    client_max_body_size 25m;
  }

  # Proxy Django i18n endpoints at top-level so /i18n/setlang/ works
  location /i18n/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Internal-API-Key $http_x_internal_api_key;
    proxy_pass http://django:8000;
    proxy_redirect off;
    client_max_body_size 5m;
  }

  # Static assets for the PHP site (after Django blocks)
  location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|webp|woff2?)$ {
    try_files $uri =404;
    access_log off;
    expires 30d;
  }

  # Main entry for the PHP site
  location / {
    try_files $uri $uri/ /index.php?$query_string;
  }

  # PHP handling
  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass php:9000;
  }
}

